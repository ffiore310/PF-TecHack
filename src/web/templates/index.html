<!DOCTYPE html>
<html>
<head>
    <title>Web Security Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .dashboard-card {
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .risk-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1rem;
        }
        .vuln-card {
            border-left: 4px solid #dee2e6;
            margin-bottom: 1rem;
        }
        .vuln-card.critical {
            border-left-color: #dc3545;
        }
        .vuln-card.high {
            border-left-color: #fd7e14;
        }
        .vuln-card.medium {
            border-left-color: #ffc107;
        }
        .vuln-card.low {
            border-left-color: #0dcaf0;
        }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Web Security Scanner</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="tab-content mt-3" id="scanTabsContent">
            <!-- Single Scan Tab -->
            <div class="tab-pane fade show active" id="single" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Novo Scan</h5>
                            </div>
                            <div class="card-body">
                                <form id="scanForm">
                                    <div class="mb-3">
                                        <label for="url" class="form-label">URL Alvo</label>
                                        <input type="url" class="form-control" id="url" required
                                               placeholder="https://exemplo.com">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Tipos de Scan</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="all" 
                                                   id="scanAll" checked>
                                            <label class="form-check-label" for="scanAll">
                                                Todos
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input scan-type" type="checkbox" 
                                                   value="xss" id="scanXss">
                                            <label class="form-check-label" for="scanXss">
                                                Cross-Site Scripting (XSS)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input scan-type" type="checkbox" 
                                                   value="sqli" id="scanSqli">
                                            <label class="form-check-label" for="scanSqli">
                                                SQL Injection
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input scan-type" type="checkbox" 
                                                   value="auth" id="scanAuth">
                                            <label class="form-check-label" for="scanAuth">
                                                Falhas de Autentica√ß√£o
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input scan-type" type="checkbox" 
                                                   value="crypto" id="scanCrypto">
                                            <label class="form-check-label" for="scanCrypto">
                                                Falhas Criptogr√°ficas
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="reportFormat" class="form-label">Formato do Relat√≥rio</label>
                                        <select class="form-select" id="reportFormat">
                                            <option value="html">HTML Interativo (Recomendado)</option>
                                            <option value="json">JSON</option>
                                            <option value="markdown">Markdown</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary" id="startScan">
                                        <i class="bi bi-play-fill"></i> Iniciar Scan
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Resultados do Scan</h5>
                            </div>
                            <div class="card-body">
                                <div id="scanStatus" class="alert alert-info d-none">
                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    Scan em andamento...
                                </div>
                                <div id="scanResults">
                                    <p class="text-muted">Os resultados aparecer√£o aqui ap√≥s o scan...</p>
                                </div>
                                <div id="downloadSection" class="d-none mt-3">
                                    <button id="downloadBtn" class="btn btn-success">
                                        <i class="bi bi-download"></i> Baixar Relat√≥rio
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                </div>
            </div>
        </div>
        
        <!-- FASE 2: Dashboard Visual -->
        <div id="dashboardSection" class="d-none mt-4">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3><i class="bi bi-speedometer2"></i> Dashboard de An√°lise</h3>
                        <button id="downloadReportBtn" class="btn btn-success">
                            <i class="bi bi-download"></i> Baixar Relat√≥rio Completo
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- M√©tricas Principais -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card dashboard-card text-center">
                        <div class="card-body">
                            <div class="metric-label">Total de Vulnerabilidades</div>
                            <div class="metric-value text-primary" id="totalVulns">0</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card dashboard-card text-center">
                        <div class="card-body">
                            <div class="metric-label">Risk Score M√©dio</div>
                            <div class="metric-value text-warning" id="avgScore">0.0</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card dashboard-card text-center">
                        <div class="card-body">
                            <div class="metric-label">N√≠vel de Risco</div>
                            <div class="metric-value" id="riskLevel">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card dashboard-card text-center">
                        <div class="card-body">
                            <div class="metric-label">Tempo de Scan</div>
                            <div class="metric-value text-info" id="scanTime">0s</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gr√°ficos -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Distribui√ß√£o por Severidade</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="severityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Vulnerabilidades por Tipo</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="typeChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Plano de Remedia√ß√£o -->
            <div class="row mb-4" id="remediationSection">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Timeline de Remedia√ß√£o</h5>
                        </div>
                        <div class="card-body">
                            <div id="timelineContent">
                                <p class="text-muted">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-lightning"></i> Quick Wins</h5>
                        </div>
                        <div class="card-body">
                            <div id="quickWinsContent">
                                <p class="text-muted">Carregando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Risk Score por Vulnerabilidade -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Vulnerabilidades Priorizadas</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 400px;">
                                <canvas id="riskScoreChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Attack Chains e Insights -->
            <div class="row mb-4" id="attackChainsSection">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Attack Chains Detectadas</h5>
                        </div>
                        <div class="card-body" id="attackChainsContent">
                            <p class="text-muted">Nenhuma attack chain detectada.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lista Detalhada de Vulnerabilidades -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Detalhes das Vulnerabilidades</h5>
                        </div>
                        <div class="card-body" id="vulnDetailsList">
                            <p class="text-muted">Nenhuma vulnerabilidade encontrada.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        console.log('‚úÖ JavaScript carregado!');
        console.log('jQuery dispon√≠vel:', typeof $ !== 'undefined');
        
        // Vari√°veis globais
        let currentScanId = null;
        let currentReportFormat = 'html';
        let charts = {};
        
        // Aguarda DOM carregar
        $(document).ready(function() {
            console.log('‚úÖ DOM pronto!');
            
            // Atualiza checkboxes de tipo de scan
            $('#scanAll').change(function() {
                $('.scan-type').prop('checked', false).prop('disabled', $(this).is(':checked'));
            });

            $('.scan-type').change(function() {
                if ($(this).is(':checked')) {
                    $('#scanAll').prop('checked', false);
                }
            });

            // Form de scan individual
            $('#scanForm').on('submit', async function(e) {
                e.preventDefault();
                console.log('üì§ Formul√°rio submetido!');
            
            // Esconde dashboard e mostra loading
            $('#dashboardSection').addClass('d-none');
            $('#scanStatus').removeClass('d-none');
            $('#scanResults').html('<p class="text-muted"><em>Executando scan...</em></p>');
            
            // Prepara dados
            let types = $('#scanAll').is(':checked') ? 'all' : 
                       $('.scan-type:checked').map(function() {
                           return $(this).val();
                       }).get().join(',');
            
            currentReportFormat = $('#reportFormat').val();
            
            // Cria form data
            let formData = new FormData();
            formData.append('url', $('#url').val());
            formData.append('type', types);
            
            try {
                // Faz requisi√ß√£o para executar scan
                const response = await fetch('/scan/execute', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                // Se for erro
                if (!response.ok || result.status === 'error') {
                    $('#scanStatus').addClass('d-none');
                    $('#scanResults').html(`
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle"></i> <strong>Erro:</strong> ${result.message}
                        </div>
                    `);
                    return;
                }
                
                // Sucesso - popula dashboard
                currentScanId = result.scan_id;
                populateDashboard(result.data);
                
                // Esconde loading e mostra dashboard
                $('#scanStatus').addClass('d-none');
                $('#scanResults').html(`
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> <strong>Scan conclu√≠do!</strong> Visualize os resultados no dashboard abaixo.
                    </div>
                `);
                $('#dashboardSection').removeClass('d-none');
                
                // Scroll suave at√© o dashboard
                $('html, body').animate({
                    scrollTop: $('#dashboardSection').offset().top - 20
                }, 500);
                
            } catch (error) {
                console.error('Erro durante o scan:', error);
                $('#scanStatus').addClass('d-none');
                $('#scanResults').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle"></i> <strong>Erro ao executar o scan:</strong> ${error.message}
                    </div>
                `);
            }
        }); // Fim do submit handler
        
        // Bot√£o de download (se√ß√£o antiga)
        $('#downloadBtn').on('click', function() {
            if (!currentScanId) {
                alert('Nenhum scan dispon√≠vel para download.');
                return;
            }
            
            // Abre URL de download
            window.location.href = `/scan/download/${currentScanId}?format=${currentReportFormat}`;
        });
        
        // Bot√£o de download do dashboard (FASE 2)
        $('#downloadReportBtn').on('click', function() {
            if (!currentScanId) {
                alert('Nenhum scan dispon√≠vel para download.');
                return;
            }
            
            // Abre URL de download
            window.location.href = `/scan/download/${currentScanId}?format=${currentReportFormat}`;
        });
        
        // Fun√ß√£o para popular o dashboard
        function populateDashboard(data) {
            // Destr√≥i gr√°ficos anteriores
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};
            
            // M√©tricas principais
            $('#totalVulns').text(data.total_vulns || 0);
            $('#scanTime').text((data.scan_time || 0).toFixed(2) + 's');
            
            // Risk summary
            const riskSummary = data.risk_summary || {};
            $('#avgScore').text((riskSummary.average_score || 0).toFixed(1));
            
            const riskLevel = riskSummary.overall_risk_level || 'LOW';
            const riskColors = {
                'CRITICAL': 'text-danger',
                'HIGH': 'text-warning',
                'MEDIUM': 'text-info',
                'LOW': 'text-success'
            };
            $('#riskLevel').text(riskLevel).attr('class', 'metric-value ' + (riskColors[riskLevel] || 'text-secondary'));
            
            // Gr√°fico de severidade (Pizza)
            createSeverityChart(riskSummary.severity_distribution || {});
            
            // Gr√°fico de tipos (Barras)
            createTypeChart(data.vulnerabilities || []);
            
            // Gr√°fico de risk scores (Barras horizontais)
            createRiskScoreChart(data.vulnerabilities || []);
            
            // Timeline de remedia√ß√£o
            populateTimeline(data.remediation_plan || {});
            
            // Quick wins
            populateQuickWins(data.remediation_plan || {});
            
            // Attack chains
            populateAttackChains(data.heuristic_insights || {});
            
            // Lista detalhada de vulnerabilidades
            populateVulnList(data.vulnerabilities || []);
        }
        
        // Cria gr√°fico de severidade
        function createSeverityChart(severityDist) {
            const ctx = document.getElementById('severityChart').getContext('2d');
            
            const data = {
                labels: Object.keys(severityDist),
                datasets: [{
                    data: Object.values(severityDist),
                    backgroundColor: [
                        '#dc3545', // Critical - vermelho
                        '#fd7e14', // High - laranja
                        '#ffc107', // Medium - amarelo
                        '#0dcaf0', // Low - cyan
                        '#6c757d'  // Info - cinza
                    ]
                }]
            };
            
            charts.severity = new Chart(ctx, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: false
                        }
                    }
                }
            });
        }
        
        // Cria gr√°fico de tipos
        function createTypeChart(vulnerabilities) {
            const ctx = document.getElementById('typeChart').getContext('2d');
            
            // Agrupa por tipo
            const typeCounts = {};
            vulnerabilities.forEach(v => {
                const type = v.type || 'Unknown';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            
            const data = {
                labels: Object.keys(typeCounts),
                datasets: [{
                    label: 'Quantidade',
                    data: Object.values(typeCounts),
                    backgroundColor: '#0d6efd'
                }]
            };
            
            charts.type = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // Cria gr√°fico de risk scores
        function createRiskScoreChart(vulnerabilities) {
            const ctx = document.getElementById('riskScoreChart').getContext('2d');
            
            // Ordena por risk score e pega top 10
            const sorted = [...vulnerabilities]
                .sort((a, b) => (b.risk_score || 0) - (a.risk_score || 0))
                .slice(0, 10);
            
            const labels = sorted.map((v, i) => `#${i+1} ${v.type}`);
            const scores = sorted.map(v => v.risk_score || 0);
            
            // Cores baseadas no score
            const colors = scores.map(score => {
                if (score >= 9) return '#dc3545';
                if (score >= 7) return '#fd7e14';
                if (score >= 4) return '#ffc107';
                return '#0dcaf0';
            });
            
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Risk Score',
                    data: scores,
                    backgroundColor: colors
                }]
            };
            
            charts.riskScore = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 10
                        }
                    }
                }
            });
        }
        
        // Popula timeline de remedia√ß√£o
        function populateTimeline(plan) {
            const timeline = plan.estimated_timeline || {};
            let html = `
                <p><strong>Tempo Total:</strong> ${timeline.total_hours || 0}h (${timeline.total_days || 0} dias)</p>
                <p class="text-muted">${timeline.recommendation || 'N/A'}</p>
                <hr>
                <h6>Breakdown por Severidade:</h6>
                <ul>
            `;
            
            const breakdown = timeline.breakdown || {};
            Object.entries(breakdown).forEach(([sev, time]) => {
                html += `<li>${sev}: ${time}</li>`;
            });
            
            html += '</ul>';
            
            const phases = plan.remediation_phases || [];
            if (phases.length > 0) {
                html += '<hr><h6>Fases:</h6><ul>';
                phases.forEach(phase => {
                    html += `<li><strong>Fase ${phase.phase}:</strong> ${phase.name} (${phase.timeframe})</li>`;
                });
                html += '</ul>';
            }
            
            $('#timelineContent').html(html);
        }
        
        // Popula quick wins
        function populateQuickWins(plan) {
            const wins = plan.quick_wins || [];
            
            if (wins.length === 0) {
                $('#quickWinsContent').html('<p class="text-muted">Nenhuma corre√ß√£o r√°pida identificada.</p>');
                return;
            }
            
            let html = '<ul class="list-group">';
            wins.forEach((win, i) => {
                html += `
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">${i+1}. ${win.vulnerability}</div>
                                <small class="text-muted">${win.location}</small>
                                <p class="mb-0 mt-1"><i class="bi bi-lightning-fill text-warning"></i> ${win.quick_fix}</p>
                            </div>
                            <span class="badge bg-primary rounded-pill">${win.estimated_time}</span>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            
            $('#quickWinsContent').html(html);
        }
        
        // Popula attack chains
        function populateAttackChains(insights) {
            const chains = insights.attack_chains || [];
            
            if (chains.length === 0) {
                $('#attackChainsSection').addClass('d-none');
                return;
            }
            
            $('#attackChainsSection').removeClass('d-none');
            
            let html = '';
            chains.forEach(chain => {
                html += `
                    <div class="alert alert-danger">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> ${chain.chain_name}</h6>
                        <p class="mb-1"><strong>Severidade:</strong> ${chain.severity}</p>
                        <p class="mb-1"><strong>Componentes:</strong> ${chain.components.join(', ')}</p>
                        <p class="mb-1"><strong>Vulnerabilidades Envolvidas:</strong> ${chain.vulnerabilities_involved}</p>
                        <hr>
                        <p class="mb-0">${chain.description}</p>
                    </div>
                `;
            });
            
            $('#attackChainsContent').html(html);
        }
        
        // Popula lista detalhada de vulnerabilidades
        function populateVulnList(vulnerabilities) {
            if (vulnerabilities.length === 0) {
                $('#vulnDetailsList').html('<p class="text-muted">Nenhuma vulnerabilidade encontrada.</p>');
                return;
            }
            
            // Ordena por prioridade de remedia√ß√£o
            const sorted = [...vulnerabilities].sort((a, b) => 
                (a.remediation_priority || 999) - (b.remediation_priority || 999)
            );
            
            let html = '';
            sorted.forEach((vuln, i) => {
                const severity = vuln.severity_level || vuln.severity || 'Medium';
                const severityClass = severity.toLowerCase();
                const riskScore = vuln.risk_score || 0;
                const priority = vuln.remediation_priority || i+1;
                
                html += `
                    <div class="card vuln-card ${severityClass} mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">
                                    <span class="badge bg-secondary">#${priority}</span>
                                    ${vuln.type}
                                </h5>
                                <span class="badge bg-${getSeverityBadgeColor(severity)} fs-6">${severity} - ${riskScore.toFixed(1)}/10</span>
                            </div>
                            <p class="card-text"><strong>URL:</strong> <code>${vuln.url || 'N/A'}</code></p>
                            <p class="card-text"><strong>M√©todo:</strong> ${vuln.method || 'N/A'}</p>
                            <p class="card-text">${vuln.description || 'N/A'}</p>
                            
                            ${vuln.metrics ? `
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <strong>M√©tricas:</strong> 
                                        Base: ${vuln.metrics.base_score} | 
                                        Impact: ${vuln.metrics.impact_score} | 
                                        Exploitability: ${vuln.metrics.exploitability}x
                                    </small>
                                </div>
                            ` : ''}
                            
                            ${vuln.recommendation ? `
                                <div class="mt-2">
                                    <strong>Recomenda√ß√£o:</strong>
                                    <p class="mb-0">${vuln.recommendation}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            $('#vulnDetailsList').html(html);
        }
        
        // Helper para cor do badge de severidade
        function getSeverityBadgeColor(severity) {
            const colors = {
                'CRITICAL': 'danger',
                'Critical': 'danger',
                'HIGH': 'warning',
                'High': 'warning',
                'MEDIUM': 'info',
                'Medium': 'info',
                'LOW': 'secondary',
                'Low': 'secondary'
            };
            return colors[severity] || 'secondary';
        }

    }); // Fim do $(document).ready

    </script>
</body>
</html>
